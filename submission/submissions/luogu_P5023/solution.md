# P5023 题解

**upd on 2018.12.28 修复了证明$Ans(n,m+1)=3 \times Ans(n,m)$的bug**

------------

当初在考场上看到数据范围以为是个玄学状压+找规律，想了一会感觉不可做的样子，于是就弃掉去淦T3了QAQ。现在我花了一晚上+一上午手玩样例推柿子，并且还口胡了这篇有~~严格~~证明的题解造（bao）福（fu）社会。

对于这道NOIplus题目，首先需要yy出两个重要的性质：

性质1、每一条对角线上填的数是单调不增的。

性质2、如果(x-1,y)和(x,y-1)的填的数相同，那么以(x,y)为左上角、以整个矩阵的右下角为右下角的子矩阵内所有对角线内的填数各自相同。

注意本文中的对角线均指从左下到右上的对角线。

![](https://i.loli.net/2018/12/26/5c2327ccb9643.png)

有时为了避免混淆，我会画成下面这个样子

![](https://i.loli.net/2018/12/26/5c23281e3108e.png)

~~总之黑框表示框里的对角线的填数要相等~~

这两个结论很容易用反证来证明，具体细节请读者自行撕烤

然后还有一个听说很显然的结论：令$Ans(n,m)$表示宽为$m$高为$n$的矩阵填数方案，则$Ans(n,m)=Ans(m,n)$。

不明白怎么回事的同学可以这样考虑

对于一个合法的$m>n$的方案，将填入的数全部反转，然后将整个矩阵顺时针转90°，最后把矩阵左右轴对称一下，就能得到一个$n>m$的方案。

![](https://i.loli.net/2018/12/26/5c232e36e39b6.png)

![](https://i.loli.net/2018/12/26/5c232e36e51ec.png)

![](https://i.loli.net/2018/12/26/5c232e36d0c17.png)

~~看上去没问题~~

于是为了方便，后文全部默认$n \le m$。

到这里就已经能手摸出$n=1$和$n=2$的情况了。我们将整个矩阵按照每一条对角线划分为若干个阶段，稍微画下图就能看出$Ans(1,m)=2^m$以及$Ans(2,m)=4 \cdot 3^{m-1}$。注意这里是保证了m大于等于n的。

~~这两个式子应该不用多解释吧~~

对于$n \ge 4$，我们再分为4种情况考虑（$n=3$的情况稍后考虑）：

case1：最上面的两个填数相同

![](https://i.loli.net/2018/12/26/5c23331d298c4.png)

case2：最上面的两个数不同，下面一条对角线的3个填数相同

![](https://i.loli.net/2018/12/26/5c23331d3d6e8.png)

case3：那3个填数为1，0，0

![](https://i.loli.net/2018/12/26/5c23331d15e4b.png)

case4：3个填数为1，1，0

![](https://i.loli.net/2018/12/26/5c23331d2b7da.png)

容易发现无论是哪种情况，总是会存在一个点(x,y)使得(x-1,y)和(x,y-1)填数相同，这样就能够限制掉一大片区域，~~是手玩通项公式的重要保证~~。

发现这个性质后就能证明出另一结论了：对于$n \ge 4$且$m \ge n+1$，有$Ans(n,m+1)=3 \times Ans(n,m)$

证明其实超简单

![](https://i.loli.net/2018/12/26/5c233cae0fc11.png)

可以发现黑框里一定是被性质2限制掉的，所以整条绿色的对角线填数都相同，而且由于绿色方框位于矩阵下边界，它是不受其它填数限制的，换句话说在所有的合法方案中，有1/2的情况它等于0，剩下1/2的情况等于1

然后考虑在原矩阵右边再添一列

![](https://i.loli.net/2018/12/26/5c233dca5f74f.png)

灰色粗♂条划掉的方格由于受到性质2的影响，它们必须要与各自左下方的格子中填数相同，因此这一部分不会对答案产生新的贡献；但蓝色位于右下角，它的填数是自由的。

![](https://i.loli.net/2018/12/26/5c233ea616b80.png)

受到性质1的限制，若绿色格子内填数为1，则右上方的方格能填0或1，会产生$2\times2=4$倍的贡献；否则只能填0，只有$2\times1=2$倍的贡献。综合起来，总的贡献就是原来的$\frac{1}{2}\times4+\frac{1}{2}\times2=3$倍。

~~简单吧，没骗你~~

**upd**：第二天晚上发现自己zz了……

因为第二排的确有可能没有被覆盖到，就像这样

![](https://i.loli.net/2018/12/28/5c25cedb3b09b.png)

于是上面的证明就愉快地GG了

紧急修一波锅

跟之后推式子的操作一样，枚举第一次出现相同数的位置，我们发现当这个位置比较靠前使得红色方块被覆盖到时是无需考虑的，因为此时与上方的情形等价= =

于是把精力集中在这两种情况

![](https://i.loli.net/2018/12/28/5c25d20828655.png)

![](https://i.loli.net/2018/12/28/5c25d2083a061.png)

考虑第一张图，原先绿色部分有3种填法，添一列后运用类似的方法分析出产生的新贡献，它是原来的$\frac{2}{3}+\frac{2}{3}+\frac{4}{3}=\frac{8}{3}$倍

同理算出第二张图是原来的$4$倍

接着同时考虑这两种情况，算出倍数$\frac{(2^{n-2}\times3\times3\times2)\times\frac{8}{3}+(2^{n-2}\times3\times2)\times4}{2^{n-2}\times3\times3\times2+2^{n-2}\times3\times2}=\frac{2^{n+2}\times3+2^{n+1}\times3}{2^{n-1}\times9+2^{n-1}\times3}=\frac{8\times3+4\times3}{9+3}=3$

这才完成了$Ans(n,m+1)=3 \times Ans(n,m)$的证明

好的下面继续原来的内容

接下来考虑$m=n$的情况来摸柿子。请各位务必要看懂以下的推倒过程，其它更一般的推倒与这里大同小异。

首先看case1。

![](https://i.loli.net/2018/12/26/5c2342af63171.png)

联系两条限制条件，不难得出每条对角线上填数的方案数，我用蓝色在图上标注了一些边界情况。容易看出$case_1=2\times2\times4^{n-2}\times2^{n-1}=8^{n-1}$

这样case1就搞定了。

然后是case2

![](https://i.loli.net/2018/12/26/5c2346917550a.png)

得到$case_2=2\times2\times5\times4^{n-4}\times2^{n-1}=5\times2^{3n-7}$

于是case2也搞定了

到现在为止一切都很美好

接下来才是真正辣手的事情

下面是case3

![](https://i.loli.net/2018/12/26/5c2352d55a660.png)

这下不好办了，因为左边两列貌似都没有什么特别的限制。不过没关系，我们可以继续分类讨论下去

我们大力讨论左边两列的对角线上从上往下第一次出现两数相同的位置，所以这之上应该都填1,0。而此时出现了一个新的限制区域，将此区域与原来的区域取并集就成了下图黑框的样子

![](https://i.loli.net/2018/12/26/5c235d0a45b81.png)

然后就可以写出每条线上的方案了

注意当x=0时右上方的对角线只能填0，而x=1时三种情况都能填，所以x那里的线是4

于是我们找出一些边界情况后就能算出整个case3了

在第一个出现

![](https://i.loli.net/2018/12/26/5c235df32bf19.png)

在倒数第二个出现

![](https://i.loli.net/2018/12/26/5c235fe05e25b.png)

在最后一个出现

![](https://i.loli.net/2018/12/26/5c23603110c72.png)

别忘了没有的情况

![](https://i.loli.net/2018/12/26/5c236044c9151.png)

于是我们可以枚举x下方4的个数，得到$case_3=2\times4\times5\times\sum\limits_{i=0}^{n-5}4^i\times2^{n-1}+2\times4\times3\times2^{n-2}+2\times3\times2^{n-2}$

于是case3也搞定了

~~好像也不怎么复杂~~

最后是case4

稍微yy一下case4的推倒发现其实与case3是完全对称的，不明白这里的同学可以手动画一下，我这里就不画了...因此$case_4=case_3$

综合以上4种cases，我们就能算出$Ans(n,n)$了。因为这4种情况完全包含了所有的可能且互不重叠，所以$Ans(n,n)=case_1+case_2+case_3+case_4$。把$case$带进式子再使劲蹂躏一下得到最终答案：

$$\displaystyle Ans(n,n)=\frac{83\cdot8^n+5\cdot2^{n+7}}{384}$$

~~累死了~~

$Ans(3,m)$与$Ans(n,n+1)$的推倒与$Ans(n,n)$大同小异，这里就略去了，直接说结论吧

$$\displaystyle Ans(3,m)=112\cdot3^{m-3}$$

$$\displaystyle Ans(n,n+1)=\frac{83\cdot8^n+2^{n+8}}{128}$$

结合$Ans(n,m+1)=3 \times Ans(n,m)$以及$Ans(n,m)=Ans(m,n)$，我们就能轻易地推出所有的$Ans(n,m)$了。

完结撒花~

~~这是本菜鸡的第一篇题解，写得狗屁不通还请见谅~~

还是贴一下代码吧
```cpp
#include<cstdio>
#define mod 1000000007
typedef long long LL;
inline LL ksm(LL a,LL b){LL r=1;for(;b;a=a*a%mod,b>>=1)if(b&1)r=r*a%mod;return r;}
int main()
{
	int n,m;
	scanf("%d%d",&n,&m);
	if(n > m)n ^= m ^= n ^= m;
	if(n == 1)printf("%lld",ksm(2,m));
	else if(n == 2)printf("%lld",4*ksm(3,m-1)%mod);
	else if(n == 3)printf("%lld",112*ksm(3,m-3)%mod);
	else
	{
		if(m == n)printf("%lld",(83*ksm(8,n)%mod+5*ksm(2,n+7)%mod)*190104168%mod);
		else printf("%lld",(83*ksm(8,n)%mod+ksm(2,n+8))*ksm(3,m-n-1)%mod*570312504%mod);
	}
	return 0;
}
```
~~若还有新bug请私信联系QwQ~~